<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Blog</title>
    <link rel="stylesheet" href="css/site.css" />
    <script src="js/site.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <script>
        let articles = []
        GetAllArticlesAsync().then((data) => {
            articles = data
            renderTagOptions()
        })
        window.onload = function () {
            this.RenderTempletesAsync(false).then()
            this.document.querySelector('#search-bar').value = this.GetUrlSearch()
            searchByInputs()
        }
    </script>
    <main>
        <div id="search-fields">
            <label for="search-bar">Search:</label>
            <input id="search-bar" type="text" class="account-text-input" contenteditable="true" />

            <label for="tag-selector">Filter by tag:</label>
            <select id="tag-selector" onchange="searchByInputs()">
                <option>(Any)</option>
            </select>
        </div>
        <h1>Search results:</h1>
        <div id="articleList" class="flex-container-column">

        </div>
    </main>
    <script>
        const search_bar = document.querySelector("#search-bar")
        const tag_selector = document.querySelector("#tag-selector")

        search_bar.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                searchByInputs()
            }
        })

        function searchByInputs() {
            const search_string = search_bar.value
            const tag_selected = tag_selector.value

            let articles_to_be_rendered = []
            articles.forEach((article) => {
                if (article.title.toLowerCase().includes(search_string.toLowerCase()) &&
                    (tag_selected === "(Any)" || article.tags.includes(tag_selected))) {
                    articles_to_be_rendered.push(article)
                }
            })

            RenderArticles(articles_to_be_rendered).then()
        }

        function renderTagOptions() {
            // get all tags from articles
            let tags = []
            articles.forEach((article) => {
                article.tags.forEach((tag) => {
                    if (!tags.includes(tag)) {
                        tags.push(tag)
                    }
                })
            })
            tags.sort()
            // for each unique tag, put an option in the tags list for it.
            tags.forEach((tag) => {
                const newOption = document.createElement('option')
                newOption.textContent = tag
                tag_selector.appendChild(newOption)
            })
        }
    </script>
</body>
</html>